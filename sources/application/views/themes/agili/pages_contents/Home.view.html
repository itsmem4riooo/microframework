<section class="corrida row">
    <div class="col-12 p-0">
        
        <form id="corrida" method="post">
          <div class="input-group mb-2 border border-muted rounded">
            <div class="input-group-prepend">
                <span class="input-group-text bg-white px-4 border-0 h-100">
                    <i class="text-muted bi bi-pin-map"></i>
                </span>
            </div>
            <input value="" type="text" name="local" placeholder="Local de partida" id="local" class="form-control bg-white border-0 mt-0 border-md pac-target-input" required="" autocomplete="off">
            <input value="" type="hidden" class="l_coords" name="l_coords[]" required="">
            <input value="" type="hidden" class="l_coords" name="l_coords[]" required="">
          </div>
          <div class="input-group mb-2 border border-muted rounded">
            <div class="input-group-prepend">
                <span class="input-group-text bg-white px-4 border-0 h-100">
                  <i class="bi bi-geo-alt text-muted"></i>
                </span>
            </div>
            <input value="" type="text" name="address" placeholder="Digite o endereço" id="address" class="form-control bg-white border-0 mt-0 border-md pac-target-input" required>
            <input value="" type="hidden" class="a_coords" name="a_coords[]" required>
            <input value="" type="hidden" class="a_coords" name="a_coords[]" required>
          </div>

            
            <div onclick="getLocation('button')" class="my-2 btn btn-info w-100" style="border-radius: 25px;"><span class="h4"><i class="text-muted bi bi-geo"></i></span> Usar minha localização!</div>
      
        
        <div class="my-3 border border-muted rounded" id="map"></div>   
        
        <div class="buscar position-relative"><input class="position-absolute end btn btn-primary" id="buscar" type="submit" value="Buscar Motorista"></div>

        </form>         
        
    </div>
</section>

<script>
        
    let map;  let markerDestiny = null; let userMarker = null; let position = null;
    let cords = {lat: -19.932041306115526 , lng: -43.94531250000001}; let zoom = 8;
       
    const getLocation = (e) => {
        
      if(navigator.geolocation){

        navigator.geolocation.getCurrentPosition(
                
          (p)=>{
                position = { lat: p.coords.latitude , lng: p.coords.longitude};
                if(e == 'button') { initMap(); } 
            },
          ()=>{
            if(e == 'button'){alert('Não foi possível encontrar sua localização!');} 
           },
           {enableHighAccuracy: true}
        
        );  

      }  
      
    };    getLocation();    

    function initMap() {

        const bounds          = new google.maps.LatLngBounds();
        
        const direction       = new google.maps.DirectionsService();
        const directionRender = new google.maps.DirectionsRenderer();
       
        const inputLocal   = document.getElementById("local");
        const inputDestiny = document.getElementById("address");
        
        const inputLocalCoords   = document.getElementsByClassName("l_coords");
        const inputDestinyCoords = document.getElementsByClassName("a_coords");
        
        const options = { componentRestrictions: { country: "br" }, fields: ["address_components", "geometry", "icon", "name"]};
         
        const autocompLocal   = new google.maps.places.SearchBox(inputLocal, options);
        const autocompDestiny = new google.maps.places.SearchBox(inputDestiny, options);

        const route = (origin,destination) => { 

                    direction.route({
                        origin: origin,
                        destination: destination,
                        travelMode: 'DRIVING'
                    }).then(response =>{
                        directionRender.setDirections(response);
                    }).catch(err => {
                        console.log(err);
                    });

                    bounds.extend(userMarker.position);          
                    bounds.extend(markerDestiny.position);  

                    map.fitBounds(bounds); 

        };
        
        const change = ($field,$lat,$lng) =>{
            $.ajax('https://maps.googleapis.com/maps/api/geocode/json?latlng='+$lat+','
            +$lng+'&key=AIzaSyDh8p1E7KyJNmCwCktrMLRQKpa8l7ixmKw').done((e)=> $($field).val(e.results[0].formatted_address));
        };  
        
        const markerChange = ($field,$m) =>{

          $m.addListener("dragend", () => {
           let p = $m.getPosition();  
           change($field,p.lat(),p.lng());
            
            if(markerDestiny){
               origin      = new google.maps.LatLng(userMarker.getPosition().lat(),userMarker.getPosition().lng());
               destination = new google.maps.LatLng(markerDestiny.getPosition().lat(),markerDestiny.getPosition().lng()); 
               route(origin,destination);
            }
            
            if($field == '#local'){
                inputLocalCoords[0].value = p.lat();
                inputLocalCoords[1].value = p.lng();
            }else{
                inputDestinyCoords[0].value = p.lat();
                inputDestinyCoords[1].value = p.lng(); 
            }
            
          });   

        };

        if(position){        
            
          zoom  = 18;  
          cords = { lat: position.lat, lng: position.lng };
          
          inputLocalCoords[0].value = cords.lat;
          inputLocalCoords[1].value = cords.lng;
          
          change("#local",cords.lat,cords.lng);
        
        }
        
        map = new google.maps.Map(document.getElementById("map"), {
            center: cords,
            zoom: zoom,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControl:false,
            streetViewControl:false,
            styles:[{ "featureType": "poi",
            "stylers": [{ "visibility": "off" }] }] 
        }); 
        
        userMarker = new google.maps.Marker({
              position: cords, map: map, animation: google.maps.Animation.DRAG,
              draggable: true, icon: "{{base}}images/person.png"
        });
       
        markerChange("#local",userMarker); 
        
        directionRender.setMap(map); directionRender.setOptions( { suppressMarkers: true } );

        autocompLocal.addListener("places_changed", () => {
          
            let origin = autocompLocal.getPlaces()[0].geometry.location;
            
            inputLocalCoords[0].value = origin.lat();
            inputLocalCoords[1].value = origin.lng();
                    
            if(userMarker){
                userMarker.setMap(null);
            }
 
            userMarker = new google.maps.Marker({
                position: { lat: origin.lat(),lng: origin.lng() },
                map: map, animation: google.maps.Animation.DRAG,
                draggable: true, icon: "{{base}}images/person.png"
            });
            
            bounds.extend(userMarker.position);   
            map.fitBounds(bounds);map.setZoom(18);

            markerChange('#local',userMarker);
            
            if(markerDestiny){
               origin      = new google.maps.LatLng(origin.lat(),origin.lng());
               destination = new google.maps.LatLng(markerDestiny.getPosition().lat(),markerDestiny.getPosition().lng()); 
               route(origin,destination);
            }
            
        });
        
        autocompDestiny.addListener("places_changed", () => {
          
            let places = autocompDestiny.getPlaces()[0].geometry.location;
            
            inputDestinyCoords[0].value = places.lat();
            inputDestinyCoords[1].value = places.lng();
                    
            if(markerDestiny !== null){
              markerDestiny.setMap(null);
            }
            
            markerDestiny =  new google.maps.Marker({
                position: { lat: places.lat(),lng: places.lng() },
                map: map,
                animation: google.maps.Animation.DRAG,
                draggable: true
            });

            origin      = new google.maps.LatLng(userMarker.getPosition().lat(),userMarker.getPosition().lng());
            destination = new google.maps.LatLng(places.lat(),places.lng());
            
            route(origin,destination);
            
            markerChange('#address',markerDestiny);

        });

        }
        
               
       const selectVehicle = e =>{
          e.querySelector('input').checked = true;
       }
       
       const form = document.getElementById('corrida');
       
       function submitForm(e){
           
         e.preventDefault();
         let formData = new FormData(form);
         
         $.ajax({
             
            url: '?con=receive_request',
            type: 'post',
            dataType: 'html',
            cache: false,
            processData: false,
            contentType: false,
            timeout: 8000,
            data: formData,
            
            success: e=>{
               console.log(e); 
            }
            
        });
         
       }
       
       form.addEventListener('submit',submitForm,false);
       
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHohn5ZPtht5YADSeJ_u9XYxsBgbHvabE&v=weekly&libraries=places&callback=initMap"  async ></script>
